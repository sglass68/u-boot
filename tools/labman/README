Labman - Lab Manager
====================

(This is not real documentation, just an idea of what labman might do)

A lab is a collection of test devices, servers and associated equipment to
connect them together. The purpose of a lab is to build and run tests and
provide access to the test devices for general use.

Labman is a program for keeping track of your lab.  It works in conjunction
with tbot and pytest to make it easier to set up your lab and keep it working.

You can use labman to:
- define available boards and how they are connected. E.g. a LinkSprite pcduino3
    may have an uSD connection to an SDwire (with USB connection to lab host),
    a UART connection to a USB UART dongle, a USB relay for reset and a USB
    YKUSH board for power.
- generate a list of avalable boards
- multithreadeed, dependency-based check that a board is working correctly,
    generating a list of things to do to get all boards working fully (but
    currently it doesn't test DUTs)
- generate board config files for tbot
- generate udev files
- provision devices ready for use in the lab (currently only SDwire)


Things labman might do in the future:
- generate board config files for pytest
- act as a repository of code to create an SD card for a board, since there is
    a lot of variation

Some sample output:

labman tools/labman/kea_lab.yaml emit -o lab_out

Example udev output:

# Generated by labman

# sdwire sdwire0
ACTION=="add|bind" \
, SUBSYSTEM=="usb" \
, ATTR{idProduct}=="6001" \
, ATTR{idVendor}=="04e8" \
, ATTR{serial}=="sdwire-18" \
, MODE="0666" \
, SYMLINK+="sdwire0"

# sdwire sdwire1
ACTION=="add|bind" \
, SUBSYSTEM=="usb" \
, ATTR{idProduct}=="6001" \
, ATTR{idVendor}=="04e8" \
, ATTR{serial}=="sdwire-7" \
, MODE="0666" \
, SYMLINK+="sdwire1"

Example tbot output:

# Generated by labman from dut pcduino3_nano

import tbot
from tbot.machine import board, channel, connector, linux
from tbot.tc import git, shell, uboot
from flash import Flash
from sdwire import Sdwire
from ykush import Ykush

class Pcduino3_NanoUBootBuilder(uboot.UBootBuilder):
    name = "pcduino3_nano"
    defconfig = "Linksprite_pcDuino3_Nano_defconfig"
    toolchain = "armv7-a"

class Pcduino3_Nano(
    connector.ConsoleConnector,
    board.PowerControl,
    board.Board,
    Flash,
    Sdwire,
    Ykush,
):
    name = "pcduino3_nano"
    desc = "Linksprite pcDuino3 Nano"
    console_uart = "/dev/ttyusb_port12"
    block_device = "/dev/sdcard4"
    sdwire_serial = "sdwireda1"
    ykush_port = "1"
    ykush_serial = "YK18511"

    ether_mac = "xx"

    def poweron(self) -> None:
        """Procedure to turn power on."""
        self.sdwire_dut()
        self.ykush_reset()

    def poweroff(self) -> None:
        """Procedure to turn power off."""
        self.ykush_off()
        self.sdwire_ts()

    def connect(self, mach) -> channel.Channel:
        """Connect to the board's serial interface."""
        return mach.open_channel("picocom", "-q", "-b", "115200",
                                 self.console_uart)

    def flash(self, repo: git.GitRepository) -> None:
        self.ykush_off()
        self.sdwire_ts()
        self.flash_sunxi(repo)
        self.sdwire_dut()


class Pcduino3_NanoUBoot(
    board.Connector,
    board.UBootAutobootIntercept,
    board.UBootShell,
):
    prompt = "=> "
    build = Pcduino3_NanoUBootBuilder()


class Pcduino3_NanoLinux(
    board.Connector,
    board.LinuxBootLogin,
    linux.Bash,
):
    username = "None"
    password = "None"


BOARD = Pcduino3_Nano
UBOOT = Pcduino3_NanoUBoot
LINUX = Pcduino3_NanoLinux


Example output from checking a lab, with progress info on first line, showing a
broken hub which breaks all the things connected to it.

$ labman -l tools/labman/kea_lab.yaml -r kea check
 32    4    9 /49      -8
Good 37, bad 12, not tested 0
   hubb: ls: cannot access '/sys/bus/usb/devices/6-2': No such file or directory
      Resulting failures: ykush1, sdwire4, sdwire8, sdwire7, usbport9, usbport10, usbport12, usbport7, em100-2, em100-1, em100-0


$ time labman -l tools/labman/kea_lab.yaml -r kea check
Good 49, bad 0, not tested 0

real	0m12.936s
user	0m1.635s
sys	0m0.730s


Example output from listing a lab:

$ labman -l tools/labman/kea_lab.yaml ls
           Name  Description
===============  ==============================
            dli  192.168.4.19, 8 ports
        em100-0  DP139140
        em100-1  DP022781
        em100-2  DP033694
           hub3  1-4, 16 ports
           huba  4-10, 16 ports
           hubb  6-2, 16 ports
           hubc  1-5, 16 ports
          jerry  Jerry
           link  Chromebook Pixel
      minnowmax  Minnowboard Max
       nyan-big  Asus Chromebook
         opi_pc  Orange Pi PC
       pcduino3  Linksprite pcDuino 3
  pcduino3_nano  Linksprite pcDuino3 Nano
          rock2  Rock 2
          rpi_3  Raspberry Pi 3b
          samus  Chromebook Pixel 2
        sdwire0  sdwire-18
        sdwire1  sdwire-7
        sdwire2  202001064004
        sdwire3  202001064001
        sdwire4  202001064005
        sdwire5  201912160005
        sdwire6  202001064003
        sdwire7  202001064002
        sdwire8  sdwireda1
        svjerry  730422-00045, port 9903
         svlink  905537-00223, port 9902
     svnyan-big  911416-00900, port 9901
        svsamus  686203-00047, port 9900
     tegra-usb0  usbdev-jetson-tk1
            tk1  Jetson TK1
       usbport1  ttyusb_port1
      usbport10  ttyusb_port10
      usbport11  ttyusb_port11
      usbport12  ttyusb_port12
       usbport2  ttyusb_port2
       usbport3  ttyusb_port3
       usbport4  ttyusb_port4
       usbport5  ttyusb_port5
       usbport6  ttyusb_port6
       usbport7  ttyusb_port7
       usbport8  ttyusb_port8
       usbport9  ttyusb_port9
      usbrelay0  6QMBS, 8 ports
         ykush0  YK17698, 3 ports
         ykush1  YK18511, 3 ports
      zynq_zybo  Zynq Zybo


Example output of the hub list:

$ labman -l tools/labman/kea_lab.yaml ls hubs
            Hub  Port   Part          Description
           hubc                       1-5, 16 ports
                 1      usbport5      ttyusb_port5
                 2      usbport6      ttyusb_port6
                 3      usbport8      ttyusb_port8
                 4      usbport1      ttyusb_port1
                 5      usbport2      ttyusb_port2
                 6      usbport3      ttyusb_port3
                 7      usbport4      ttyusb_port4
                 8      sdwire2       202001064004
                 9      sdwire0       sdwire-18
                 10     sdwire1       sdwire-7
                 11     sdwire3       202001064001
                 12     -
                 13     sdwire5       201912160005
                 14     ykush0        YK17698, 3 ports
                 15     ykush0        YK17698, power
                 16     sdwire6       202001064003

           hubb                       6-2, 16 ports
                 1      usbport9      ttyusb_port9
                 2      usbport12     ttyusb_port12
                 3      usbport7      ttyusb_port7
                 4      em100-2       DP033694
                 5      em100-0       DP139140
                 6      em100-1       DP022781
                 7      usbport10     ttyusb_port10
                 8      sdwire7       202001064002
                 9      sdwire4       202001064005
                 10     ykush1        YK18511, power
                 11     ykush1        YK18511, 3 ports
                 12     sdwire8       sdwireda1
                 13     -
                 14     -
                 15     -
                 16     -

           huba                       4-10, 16 ports
                 1      -
                 2      -
                 3      -
                 4      -
                 5      svsamus       686203-00047, port 9900
                 6      svnyan-big    911416-00900, port 9901
                 7      svlink        905537-00223, port 9902
                 8      svjerry       730422-00045, port 9903
                 9      -
                 10     -
                 11     -
                 12     -
                 13     tegra-usb0    usbdev-jetson-tk1
                 14     usbrelay0     6QMBS, 8 ports
                 15     -
                 16     -

           hubd                       1-4, 16 ports
                 1      usbport11     ttyusb_port11
                 2      usbrelay1     QAAMZ, 4 ports
                 3      -
                 4      -
                 5      -
                 6      -
                 7      -
                 8      -
                 9      -
                 10     -
                 11     -
                 12     -
                 13     -
                 14     -
                 15     -
                 16     -


$ labman -D -l tools/labman/kea_lab.yaml -r kea scan
2 new part(s) found
            Hub  Port   Part          Description
           huba  3      uart          ttyUSB12
           huba  4      sdwire        sdwireda3
